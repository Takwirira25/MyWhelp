<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyWhelp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .form-input {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .form-input:focus {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            outline: none;
        }
        .form-input::placeholder { color: rgba(255, 255, 255, 0.6); }
        .form-input option { background-color: #3730a3; }
        .tab-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-bottom: 3px solid #fff;
        }
        .hidden { display: none; }
        .btn-status {
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .btn-status.selected {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .accordion-header { cursor: pointer; }
        .select-dropdown {
            position: relative;
            width: 100%;
        }
        .select-dropdown-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            color: white;
        }
        .select-dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #3730a3;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 0.25rem;
        }
        .select-dropdown-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: white;
        }
        .select-dropdown-option:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .select-dropdown-option input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        .select-dropdown-option.selected {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .like-btn.liked {
            color: #3b82f6; /* blue-500 */
        }
        .dislike-btn.disliked {
            color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-800 to-purple-800 text-white min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-6xl mx-auto">
        <!-- Login Card -->
        <div id="login-card" class="glass-effect rounded-2xl p-8 shadow-2xl max-w-md mx-auto">
            <h2 class="text-3xl font-bold text-center mb-2">Welcome to <span class="font-extrabold">MyWhelp</span></h2>
            <p id="login-intro-text" class="text-center text-gray-300 mb-6">Are you a new or returning user?</p>

            <div id="user-type-selection" class="flex flex-col gap-4">
                <button class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center" onclick="showReturningUserForm()"><i class="fas fa-sign-in-alt mr-2"></i>I'm a Returning User</button>
                <button class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center" onclick="showNewUserForm()"><i class="fas fa-user-plus mr-2"></i>I'm a New User</button>
            </div>

            <div id="returning-user-form" class="hidden">
                <div class="relative mb-4">
                    <i class="fas fa-envelope absolute top-3.5 left-4 text-gray-400"></i>
                    <input type="email" id="loginEmail" placeholder="Email" class="form-input w-full pl-12 pr-4 py-3 rounded-lg">
                </div>
                <div class="relative mb-4">
                    <i class="fas fa-lock absolute top-3.5 left-4 text-gray-400"></i>
                    <input type="password" id="loginPassword" placeholder="Password" class="form-input w-full pl-12 pr-4 py-3 rounded-lg">
                </div>
                <button id="login-button" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 mb-2" onclick="loginUser()">Login</button>
                <button class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 mb-2" onclick="showForgotPasswordModal()">Forgot Password?</button>
                <button class="w-full bg-transparent hover:bg-white/10 border border-white/20 text-white font-bold py-2 px-4 rounded-lg transition duration-300" onclick="goBackToSelection()">Back</button>
            </div>

            <div id="new-user-form" class="hidden">
                <input type="text" id="firstName" placeholder="First Name" class="form-input w-full mb-3 p-3 rounded-lg">
                <input type="text" id="lastName" placeholder="Last Name" class="form-input w-full mb-3 p-3 rounded-lg">
                <input type="email" id="email" placeholder="Email" class="form-input w-full mb-3 p-3 rounded-lg">
                <input type="password" id="password" placeholder="Password" class="form-input w-full mb-3 p-3 rounded-lg">
                <select id="userRole" class="form-input w-full p-3 rounded-lg">
                    <option value="" disabled selected>Select your role</option>
                    <option value="Early Youth">Early Youth</option>
                    <option value="Early Youth Instructor">Early Youth Instructor</option>
                    <option value="Early Youth Advisor">Early Youth Advisor</option>
                    <option value="TC">Territorial Coordinator (TC)</option>
                    <option value="RC">Regional Coordinator (RC)</option>
                </select>
                <button id="register-button" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 mt-4" onclick="registerUser()">Register</button>
                <button class="w-full bg-transparent hover:bg-white/10 border border-white/20 text-white font-bold py-2 px-4 rounded-lg transition duration-300 mt-2" onclick="goBackToSelection()">Back</button>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <div>
                    <h3 id="welcomeText" class="text-2xl font-bold"></h3>
                    <span id="userIdDisplay" class="text-xs text-gray-400 mt-1"></span>
                </div>
                <button class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg transition duration-300" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
            </div>

            <div class="border-b border-white/20 mb-4 overflow-x-auto">
                <nav id="menuTabs" class="flex space-x-2" aria-label="Tabs"></nav>
            </div>

            <div id="tab-content-container" class="glass-effect rounded-2xl p-6 shadow-xl"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-2xl p-6 shadow-2xl max-w-sm w-full">
            <h5 class="text-xl font-bold mb-4" id="alertModalLabel">Message</h5>
            <p id="alertModalBody" class="mb-6"></p>
            <button class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg" onclick="document.getElementById('alertModal').classList.add('hidden')">OK</button>
        </div>
    </div>
    
    <div id="forgotPasswordModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-2xl p-6 shadow-2xl max-w-md w-full">
            <h5 class="text-xl font-bold mb-4">Reset Your Password</h5>
            <p class="text-gray-300 mb-4">Enter your email address to receive a password reset link.</p>
            <input type="email" id="resetPasswordEmail" placeholder="Enter your email" class="form-input w-full mb-3 p-3 rounded-lg">
            <div class="flex justify-end gap-4 mt-6">
                <button class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" onclick="document.getElementById('forgotPasswordModal').classList.add('hidden')">Cancel</button>
                <button class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg" onclick="sendPasswordResetEmailHandler()">Send Reset Email</button>
            </div>
        </div>
    </div>

    <div id="emailVerificationModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-2xl p-6 shadow-2xl max-w-md w-full text-center">
            <h5 class="text-xl font-bold mb-4" id="emailVerificationModalTitle">Verify Your Email</h5>
            <p id="emailVerificationModalBody" class="text-gray-300 mb-6">
                A verification email has been sent to your address. Please check your inbox (and spam folder) to verify your account.
                You will be able to log in after verification.
            </p>
            <button id="resendVerificationEmailBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 mb-2" onclick="resendVerificationEmail()">Resend Verification Email</button>
            <button class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300" onclick="window.hideEmailVerificationModal()">OK</button>
        </div>
    </div>

    <div id="announcementViewModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-2xl p-6 shadow-2xl max-w-xl w-full">
            <h5 class="text-xl font-bold mb-4" id="announcementModalSubject"></h5>
            <div class="text-sm text-gray-400 mb-2">From: <span id="announcementModalSender"></span></div>
            <div class="text-sm text-gray-400 mb-4">Date: <span id="announcementModalDate"></span></div>
            <p id="announcementModalMessage" class="mb-6 whitespace-pre-wrap"></p>
            <div class="flex justify-end">
                <button class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg" onclick="document.getElementById('announcementViewModal').classList.add('hidden')">Close</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-2xl p-6 shadow-2xl max-w-2xl w-full">
            <h5 class="text-xl font-bold mb-4">Report Details</h5>
            <div class="text-sm text-gray-400 mb-2">Author: <span id="reportAuthor"></span></div>
            <div class="text-sm text-gray-400 mb-2">Date: <span id="reportDate"></span></div>
            <div id="editCountInfo" class="text-sm text-yellow-400 mb-4"></div>
            <textarea id="reportModalTextarea" class="form-input w-full p-3 rounded-lg text-white h-64" readonly></textarea>
            <div class="flex justify-end gap-4 mt-6">
                <button class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" onclick="document.getElementById('reportModal').classList.add('hidden')">Close</button>
                <button id="editReportButton" class="bg-blue-500 hover:bg-blue-400 text-white font-bold py-2 px-4 rounded-lg hidden">Edit</button>
                <button id="saveEditedReportButton" class="bg-green-500 hover:bg-green-400 text-white font-bold py-2 px-4 rounded-lg hidden">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="editTodoModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-2xl p-6 shadow-2xl max-w-md w-full">
            <h5 class="text-xl font-bold mb-4">Edit To-do Item</h5>
            <input type="text" id="editTodoInput" class="form-input w-full p-3 rounded-lg">
            <div class="flex justify-end gap-4 mt-6">
                <button class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" onclick="document.getElementById('editTodoModal').classList.add('hidden')">Cancel</button>
                <button id="saveTodoEditButton" class="bg-green-500 hover:bg-green-400 text-white font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <div id="evaluationModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-2xl p-6 shadow-2xl max-w-md w-full">
            <h5 class="text-xl font-bold mb-4">Give Evaluation</h5>
            <p class="mb-4">Evaluating: <span id="evalStudentName" class="font-semibold"></span></p>
            <select id="evaluationValue" class="form-input w-full p-3 rounded-lg">
                <option value="" disabled selected>Select evaluation</option>
                <option value="Excellent">Excellent</option>
                <option value="Good">Good</option>
                <option value="Needs Improvement">Needs Improvement</option>
            </select>
            <div class="flex justify-end gap-4 mt-6">
                <button class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" onclick="document.getElementById('evaluationModal').classList.add('hidden')">Cancel</button>
                <button id="saveEvaluationButton" class="bg-green-500 hover:bg-green-400 text-white font-bold py-2 px-4 rounded-lg">Submit Evaluation</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, getDocs, collection, query, where, onSnapshot, updateDoc, deleteDoc, serverTimestamp, writeBatch, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Environment & Config ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mywhelp-dev-app';
        const firebaseConfig = {
            apiKey: "AIzaSyCOc_f94DMGC5XVI2rf1baKp5lWJWnkrKo",
            authDomain: "samrad-quiz.firebaseapp.com",
            projectId: "samrad-quiz",
            storageBucket: "samrad-quiz.firebasestorage.app",
            messagingSenderId: "853162839858",
            appId: "1:853162839858:web:9eb0fde5b5a442a067d12b"
        };
        
        // --- Firebase Services & State ---
        let app, auth, db;
        let currentUserId; // Firebase Auth UID
        let currentUserProfile = {}; // MyWhelp app user profile
        let unsubscribeListeners = []; // To detach listeners on logout
        let allUsers = []; // To store all user profiles for recipient selection

        // --- Firestore Paths ---
        const PUBLIC_USERS_COLLECTION = `artifacts/${appId}/public/data/mywhelp_users`;
        const getPrivateNotesCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/personal_notes`;
        const getPrivateTodosCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/todos`;
        const PUBLIC_REPORTS_COLLECTION = `artifacts/${appId}/public/data/reports`;
        const PUBLIC_ATTENDANCE_COLLECTION = `artifacts/${appId}/public/data/attendance`;
        const PUBLIC_EVALUATIONS_COLLECTION = `artifacts/${appId}/public/data/evaluations`;
        const PUBLIC_DISCUSSIONS_COLLECTION = `artifacts/${appId}/public/data/discussions`;
        const PUBLIC_ANNOUNCEMENTS_COLLECTION = `artifacts/${appId}/public/data/announcements`;
        const PUBLIC_NEXT_TOPIC_DOC = `artifacts/${appId}/public/data/topics/next_week`;

        // --- Initialization ---
        async function initializeAppAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        if (!user.emailVerified) {
                            showEmailVerificationModal("Verify Your Email", "Your email address is not verified. Please check your inbox (and spam folder) for a verification link. You must verify your email to access the application.");
                            showLoginContent();
                            return;
                        }
                        const userDocRef = doc(db, PUBLIC_USERS_COLLECTION, currentUserId);
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            await loadUserProfile(currentUserId);
                        } else {
                            showCustomAlert("Your user profile could not be found. Please contact support.", "Profile Missing");
                            await signOut(auth);
                            showLoginContent();
                        }
                    } else {
                        cleanupOnLogout();
                        showLoginContent();
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showCustomAlert("Critical Error: Could not initialize the application.");
            }
        }
        
        // --- User Profile & Session Management ---
        async function loadUserProfile(uid) {
            const userDocRef = doc(db, PUBLIC_USERS_COLLECTION, uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                currentUserProfile = { uid: uid, ...userDocSnap.data() };
                await fetchAllUsers();
                showMainContent();
            } else {
                showCustomAlert("Your user profile could not be found. Please contact support.", "Profile Missing");
                await signOut(auth);
                showLoginContent();
            }
        }

        async function fetchAllUsers() {
            try {
                const usersCollectionRef = collection(db, PUBLIC_USERS_COLLECTION);
                const querySnapshot = await getDocs(usersCollectionRef);
                allUsers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error fetching all users:", error);
            }
        }
        
        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout Error:", error);
            }
        };

        function cleanupOnLogout() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            currentUserProfile = {};
            currentUserId = null;
            allUsers = [];
        }

        // --- UI State Management ---
        function showLoginContent() {
            document.getElementById('login-card').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
            goBackToSelection();
        }

        function showMainContent() {
            document.getElementById('login-card').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('welcomeText').textContent = `Welcome, ${currentUserProfile.name}!`;
            document.getElementById('userIdDisplay').textContent = `ID: ${currentUserProfile.uid}`;
            setupDynamicUI();
        }
        
        window.showReturningUserForm = () => {
            document.getElementById('user-type-selection').classList.add('hidden');
            document.getElementById('returning-user-form').classList.remove('hidden');
            document.getElementById('new-user-form').classList.add('hidden');
            document.getElementById('login-intro-text').textContent = "Enter your email and password.";
        };

        window.showNewUserForm = () => {
            document.getElementById('user-type-selection').classList.add('hidden');
            document.getElementById('returning-user-form').classList.add('hidden');
            document.getElementById('new-user-form').classList.remove('hidden');
            document.getElementById('login-intro-text').textContent = "Create your new account.";
        };

        window.goBackToSelection = () => {
            document.getElementById('user-type-selection').classList.remove('hidden');
            document.getElementById('returning-user-form').classList.add('hidden');
            document.getElementById('new-user-form').classList.add('hidden');
            document.getElementById('login-intro-text').textContent = "Are you a new or returning user?";
            // Clear form fields
            ['loginEmail', 'loginPassword', 'firstName', 'lastName', 'email', 'password', 'userRole'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        };
        
        // --- Authentication Functions ---
        window.registerUser = async () => {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const role = document.getElementById('userRole').value;

            if (!firstName || !lastName || !email || !password || !role) {
                showCustomAlert("Please fill in all registration fields.");
                return;
            }
            if (password.length < 6) {
                showCustomAlert("Password must be at least 6 characters long.");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userDocRef = doc(db, PUBLIC_USERS_COLLECTION, user.uid);
                await setDoc(userDocRef, {
                    name: `${firstName} ${lastName}`,
                    email: email,
                    role: role,
                    createdAt: serverTimestamp(),
                    uid: user.uid
                });
                await sendEmailVerification(user);
                showEmailVerificationModal("Registration Successful!", `A verification email has been sent to ${email}. Please verify your email to log in.`);
                goBackToSelection();
            } catch (error) {
                handleAuthError(error, "Registration failed.");
            }
        };

        window.loginUser = async () => {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!email || !password) {
                showCustomAlert("Please enter your email and password.");
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (!userCredential.user.emailVerified) {
                    showEmailVerificationModal("Email Not Verified", "Your email address is not verified. Please check your inbox for a verification link or resend the email.");
                    await signOut(auth);
                }
            } catch (error) {
                handleAuthError(error, "Login failed.");
            }
        };

        window.sendPasswordResetEmailHandler = async () => {
            const email = document.getElementById('resetPasswordEmail').value.trim();
            if (!email) {
                showCustomAlert("Please enter your email address.");
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showCustomAlert("Password reset email sent! Check your inbox.");
                document.getElementById('forgotPasswordModal').classList.add('hidden');
            } catch (error) {
                handleAuthError(error, "Failed to send password reset email.");
            }
        };

        window.resendVerificationEmail = async () => {
            const user = auth.currentUser;
            if (user) {
                try {
                    await sendEmailVerification(user);
                    showCustomAlert("Verification email resent! Please check your inbox.");
                } catch (error) {
                    handleAuthError(error, "Failed to resend verification email.");
                }
            }
        };

        function handleAuthError(error, defaultMessage) {
            let message = defaultMessage;
            switch (error.code) {
                case 'auth/email-already-in-use': message = "This email is already registered."; break;
                case 'auth/invalid-email': message = "Invalid email address format."; break;
                case 'auth/weak-password': message = "Password is too weak."; break;
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': message = "Invalid email or password."; break;
            }
            showCustomAlert(message);
            console.error("Auth Error:", error.code, error.message);
        }

        // --- Modal Functions ---
        function showCustomAlert(message, title = "Message") {
            document.getElementById('alertModalLabel').textContent = title;
            document.getElementById('alertModalBody').textContent = message;
            document.getElementById('alertModal').classList.remove('hidden');
        }
        
        window.showForgotPasswordModal = () => {
            document.getElementById('forgotPasswordModal').classList.remove('hidden');
        };

        function showEmailVerificationModal(title, message) {
            document.getElementById('emailVerificationModalTitle').textContent = title;
            document.getElementById('emailVerificationModalBody').textContent = message;
            document.getElementById('emailVerificationModal').classList.remove('hidden');
        }
        
        window.hideEmailVerificationModal = () => {
            document.getElementById('emailVerificationModal').classList.add('hidden');
            goBackToSelection();
        };

        // --- Dynamic UI Setup ---
        function setupDynamicUI() {
            const menuTabs = document.getElementById('menuTabs');
            menuTabs.innerHTML = '';
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            const role = currentUserProfile.role;
            const roleTabs = {
                'Early Youth': ['Announcements', 'Discussions', 'Next Week\'s Topic', 'Evaluations', 'Attendance', 'To-dos', 'Notes'],
                'Early Youth Instructor': ['Announcements', 'Discussions', 'Next Week\'s Topic', 'Attendance', 'Evaluations', 'Reports', 'To-dos', 'Notes'],
                'Early Youth Advisor': ['Announcements', 'Discussions', 'Next Week\'s Topic', 'Attendance', 'Evaluations', 'Reports', 'To-dos', 'Notes'],
                'TC': ['Announcements', 'Discussions', 'Next Week\'s Topic', 'Reports', 'To-dos', 'Notes'],
                'RC': ['Announcements', 'Discussions', 'Next Week\'s Topic', 'Reports', 'To-dos', 'Notes']
            };

            const tabsToRender = roleTabs[role] || [];
            tabsToRender.forEach((tab, index) => {
                const tabButton = document.createElement('button');
                tabButton.className = `tab-link py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-300 whitespace-nowrap`;
                tabButton.textContent = tab;
                tabButton.onclick = () => {
                    menuTabs.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
                    tabButton.classList.add('active');
                    renderTabContent(tab);
                };
                menuTabs.appendChild(tabButton);
                if (index === 0) tabButton.click();
            });
        }
        
        function renderTabContent(tab) {
            const container = document.getElementById('tab-content-container');
            container.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-4xl"></i></div>`;
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            
            switch (tab) {
                case 'Announcements': renderAnnouncements(); break;
                case 'Discussions': renderDiscussions(); break;
                case 'Next Week\'s Topic': renderNextWeeksTopic(); break;
                case 'To-dos': renderTodos(); break;
                case 'Notes': renderNotes(); break;
                case 'Reports': renderReports(); break;
                case 'Attendance': renderAttendance(); break;
                case 'Evaluations': renderEvaluations(); break;
                default: container.innerHTML = `<p>Content for ${tab} coming soon.</p>`;
            }
        }
        
        // --- Multi-Select Dropdown Component ---
        function renderMultiSelectAudience(id, options) {
            const optionsHTML = options.map(option => `
                <div class="select-dropdown-option" data-value="${option.value}">
                    <input type="checkbox" class="pointer-events-none"><label class="ml-2 pointer-events-none">${option.label}</label>
                </div>`).join('');
            return `<div id="${id}" class="select-dropdown"><div class="select-dropdown-button"><span>Select Recipients</span><i class="fas fa-chevron-down"></i></div><div class="select-dropdown-options hidden">${optionsHTML}</div></div>`;
        }
        
        function initializeMultiSelect(containerId) {
            const dropdown = document.getElementById(containerId);
            if (!dropdown) return;
            const button = dropdown.querySelector('.select-dropdown-button');
            const optionsContainer = dropdown.querySelector('.select-dropdown-options');
            button.addEventListener('click', (e) => { e.stopPropagation(); optionsContainer.classList.toggle('hidden'); });
            dropdown.querySelectorAll('.select-dropdown-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const checkbox = option.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    option.classList.toggle('selected', checkbox.checked);
                    updateButtonText();
                });
            });
            const updateButtonText = () => {
                const selected = Array.from(dropdown.querySelectorAll('.select-dropdown-option input:checked'));
                button.querySelector('span').textContent = selected.length ? `${selected.length} recipients selected` : 'Select Recipients';
            };
            document.addEventListener('click', () => optionsContainer.classList.add('hidden'));
        }

        function getSelectedMultiSelectValues(containerId) {
            const dropdown = document.getElementById(containerId);
            return dropdown ? Array.from(dropdown.querySelectorAll('.select-dropdown-option input:checked')).map(cb => cb.closest('.select-dropdown-option').dataset.value) : [];
        }

        // --- Tab Rendering Functions ---
        
        async function renderAnnouncements() {
            const container = document.getElementById('tab-content-container');
            const canPublish = ['Early Youth Instructor', 'Early Youth Advisor', 'TC', 'RC'].includes(currentUserProfile.role);
            
            let formHTML = '';
            if (canPublish) {
                const audienceOptions = [
                    { value: 'all', label: 'All Users' },
                    { value: 'Early Youth', label: 'All Early Youth' },
                    { value: 'Early Youth Instructor', label: 'All Instructors' },
                    { value: 'Early Youth Advisor', label: 'All Advisors' },
                    ...allUsers.map(u => ({ value: u.id, label: `${u.name} (${u.role})` }))
                ];
                formHTML = `
                    <div class="mb-6 p-4 glass-effect rounded-lg">
                        <h4 class="text-lg font-bold mb-4">Create New Announcement</h4>
                        <input type="text" id="announcementSubject" placeholder="Subject" class="form-input w-full p-3 rounded-lg mb-3">
                        <textarea id="announcementMessage" placeholder="Your message..." class="form-input w-full p-3 rounded-lg mb-3 h-24"></textarea>
                        <div class="mb-4 relative z-10">
                            <label class="block text-sm font-medium text-gray-300 mb-1">Select Audience</label>
                            ${renderMultiSelectAudience('announcementAudience', audienceOptions)}
                        </div>
                        <button id="publishAnnouncementBtn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Publish</button>
                    </div>`;
            }

            container.innerHTML = `${formHTML}<h3 class="text-xl font-bold mb-4">Announcements</h3><div id="announcements-list" class="space-y-4"></div>`;
            
            if (canPublish) {
                initializeMultiSelect('announcementAudience');
                document.getElementById('publishAnnouncementBtn').onclick = publishAnnouncement;
            }

            const q = query(collection(db, PUBLIC_ANNOUNCEMENTS_COLLECTION), where('recipientUids', 'array-contains-any', [currentUserId, currentUserProfile.role, 'all']));
            const unsub = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('announcements-list');
                if (!list) return;
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-400">No announcements for you at this time.</p>';
                    return;
                }
                const announcements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                list.innerHTML = announcements.map(ann => `
                    <div class="p-4 glass-effect rounded-lg cursor-pointer hover:bg-white/10" onclick="viewAnnouncement('${ann.id}')">
                        <div class="flex justify-between items-start">
                            <div><p class="font-bold">${ann.subject}</p><p class="text-sm text-gray-400">From: ${ann.authorName}</p></div>
                            <p class="text-xs text-gray-400 whitespace-nowrap ml-4">${new Date(ann.createdAt.toMillis()).toLocaleString()}</p>
                        </div>
                    </div>`).join('');
                
                window.viewAnnouncement = (id) => {
                    const ann = announcements.find(a => a.id === id);
                    if (ann) {
                        document.getElementById('announcementModalSubject').textContent = ann.subject;
                        document.getElementById('announcementModalSender').textContent = ann.authorName;
                        document.getElementById('announcementModalDate').textContent = new Date(ann.createdAt.toMillis()).toLocaleString();
                        document.getElementById('announcementModalMessage').textContent = ann.message;
                        document.getElementById('announcementViewModal').classList.remove('hidden');
                    }
                };
            });
            unsubscribeListeners.push(unsub);
        }

        async function publishAnnouncement() {
            const subject = document.getElementById('announcementSubject').value.trim();
            const message = document.getElementById('announcementMessage').value.trim();
            const recipientUids = getSelectedMultiSelectValues('announcementAudience');

            if (!subject || !message || recipientUids.length === 0) {
                showCustomAlert("Please fill in all fields and select an audience.");
                return;
            }
            try {
                await addDoc(collection(db, PUBLIC_ANNOUNCEMENTS_COLLECTION), {
                    authorId: currentUserId,
                    authorName: currentUserProfile.name,
                    subject, message, recipientUids,
                    createdAt: serverTimestamp()
                });
                showCustomAlert("Announcement published!", "Success");
                document.getElementById('announcementSubject').value = '';
                document.getElementById('announcementMessage').value = '';
            } catch (error) {
                console.error("Error publishing announcement:", error);
            }
        }
        
        async function renderDiscussions() {
            const container = document.getElementById('tab-content-container');
            const canCreate = currentUserProfile.role === 'Early Youth Instructor';
            let formHTML = canCreate ? `
                <div class="mb-6 p-4 glass-effect rounded-lg">
                    <h4 class="text-lg font-bold mb-4">Start a New Discussion</h4>
                    <input type="text" id="discussionSubject" placeholder="Discussion Topic/Subject" class="form-input w-full p-3 rounded-lg mb-3">
                    <textarea id="discussionMessage" placeholder="Opening message..." class="form-input w-full p-3 rounded-lg mb-3 h-24"></textarea>
                    <button id="publishDiscussionBtn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Start Discussion</button>
                </div>` : '';

            container.innerHTML = `${formHTML}<h3 class="text-xl font-bold mb-4">Weekly Discussions</h3><div id="discussions-list" class="space-y-6"></div>`;
            
            if (canCreate) {
                document.getElementById('publishDiscussionBtn').onclick = publishDiscussion;
            }

            const q = query(collection(db, PUBLIC_DISCUSSIONS_COLLECTION));
            const unsub = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('discussions-list');
                if (!list) return;
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-400">No discussions have been started yet.</p>';
                    return;
                }
                const discussions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                
                list.innerHTML = discussions.map(disc => {
                    const userHasLiked = disc.likes?.includes(currentUserId);
                    const userHasDisliked = disc.dislikes?.includes(currentUserId);
                    
                    return `
                    <div class="p-4 glass-effect rounded-lg">
                        <div>
                            <p class="font-bold text-lg">${disc.subject}</p>
                            <p class="text-sm text-gray-400">By ${disc.authorName} on ${new Date(disc.createdAt.toMillis()).toLocaleDateString()}</p>
                            <p class="mt-2 text-gray-200 whitespace-pre-wrap">${disc.message}</p>
                        </div>
                        <div class="flex items-center gap-4 mt-4 border-t border-white/10 pt-3">
                            <button onclick="toggleLike('${disc.id}')" class="like-btn ${userHasLiked ? 'liked' : ''} text-gray-400 hover:text-blue-400 transition-colors"><i class="fas fa-thumbs-up"></i> ${disc.likes?.length || 0}</button>
                            <button onclick="toggleDislike('${disc.id}')" class="dislike-btn ${userHasDisliked ? 'disliked' : ''} text-gray-400 hover:text-red-400 transition-colors"><i class="fas fa-thumbs-down"></i> ${disc.dislikes?.length || 0}</button>
                            <button onclick="toggleComments('${disc.id}')" class="text-gray-400 hover:text-white transition-colors"><i class="fas fa-comment"></i> Comments</button>
                        </div>
                        <div id="comments-section-${disc.id}" class="hidden mt-4 pl-4 border-l-2 border-white/10">
                            <div id="comments-list-${disc.id}" class="space-y-3"></div>
                            <div class="mt-4 flex gap-2">
                                <input type="text" id="comment-input-${disc.id}" placeholder="Add a comment..." class="form-input flex-grow p-2 rounded-lg">
                                <button onclick="addComment('${disc.id}')" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-3 rounded-lg">Post</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            });
            unsubscribeListeners.push(unsub);
        }
        
        window.toggleComments = (discussionId) => {
            const commentsSection = document.getElementById(`comments-section-${discussionId}`);
            if (commentsSection.classList.toggle('hidden')) {
                // If section is now hidden, detach listener if one exists
                const unsub = window[`unsubComments_${discussionId}`];
                if (unsub) unsub();
            } else {
                // Section is now visible, fetch and listen for comments
                const commentsList = document.getElementById(`comments-list-${discussionId}`);
                const commentsRef = collection(db, PUBLIC_DISCUSSIONS_COLLECTION, discussionId, 'comments');
                const q = query(commentsRef);
                window[`unsubComments_${discussionId}`] = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        commentsList.innerHTML = '<p class="text-xs text-gray-500">No comments yet.</p>';
                        return;
                    }
                    commentsList.innerHTML = snapshot.docs.map(doc => {
                        const comment = doc.data();
                        return `<div class="text-sm"><p class="font-semibold">${comment.authorName}</p><p class="text-gray-300">${comment.text}</p></div>`;
                    }).join('');
                });
            }
        };

        window.addComment = async (discussionId) => {
            const input = document.getElementById(`comment-input-${discussionId}`);
            const text = input.value.trim();
            if (!text) return;
            try {
                await addDoc(collection(db, PUBLIC_DISCUSSIONS_COLLECTION, discussionId, 'comments'), {
                    text,
                    authorId: currentUserId,
                    authorName: currentUserProfile.name,
                    createdAt: serverTimestamp()
                });
                input.value = '';
            } catch (error) {
                console.error("Error adding comment:", error);
            }
        };

        window.toggleLike = async (discussionId) => {
            const docRef = doc(db, PUBLIC_DISCUSSIONS_COLLECTION, discussionId);
            const batch = writeBatch(db);
            batch.update(docRef, { likes: arrayUnion(currentUserId) });
            batch.update(docRef, { dislikes: arrayRemove(currentUserId) });
            await batch.commit();
        };

        window.toggleDislike = async (discussionId) => {
            const docRef = doc(db, PUBLIC_DISCUSSIONS_COLLECTION, discussionId);
            const batch = writeBatch(db);
            batch.update(docRef, { dislikes: arrayUnion(currentUserId) });
            batch.update(docRef, { likes: arrayRemove(currentUserId) });
            await batch.commit();
        };

        async function publishDiscussion() {
            const subject = document.getElementById('discussionSubject').value.trim();
            const message = document.getElementById('discussionMessage').value.trim();
            if (!subject || !message) {
                showCustomAlert("Please fill in the subject and message for the discussion.");
                return;
            }
            try {
                await addDoc(collection(db, PUBLIC_DISCUSSIONS_COLLECTION), {
                    authorId: currentUserId,
                    authorName: currentUserProfile.name,
                    subject, message,
                    likes: [],
                    dislikes: [],
                    createdAt: serverTimestamp()
                });
                showCustomAlert("Discussion started!", "Success");
                document.getElementById('discussionSubject').value = '';
                document.getElementById('discussionMessage').value = '';
            } catch (error) {
                console.error("Error publishing discussion:", error);
            }
        }
        
        async function renderNextWeeksTopic() {
            const container = document.getElementById('tab-content-container');
            const canEdit = currentUserProfile.role === 'Early Youth Instructor';
            
            container.innerHTML = `
                <h3 class="text-xl font-bold mb-4">Next Week's Topic</h3>
                <div class="p-4 glass-effect rounded-lg">
                    ${canEdit ? `
                        <textarea id="nextTopicText" placeholder="Enter the topic for next week..." class="form-input w-full p-3 rounded-lg h-24"></textarea>
                        <button id="saveNextTopicBtn" class="mt-2 w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Save Topic</button>
                    ` : `
                        <div id="nextTopicDisplay" class="text-gray-300 min-h-[5rem] whitespace-pre-wrap">No topic posted yet.</div>
                    `}
                </div>
            `;

            if (canEdit) {
                document.getElementById('saveNextTopicBtn').onclick = async () => {
                    const text = document.getElementById('nextTopicText').value.trim();
                    if (!text) {
                        showCustomAlert("Please enter a topic.");
                        return;
                    }
                    try {
                        await setDoc(doc(db, PUBLIC_NEXT_TOPIC_DOC), {
                            topic: text,
                            authorName: currentUserProfile.name,
                            updatedAt: serverTimestamp()
                        });
                        showCustomAlert("Next week's topic has been saved!", "Success");
                    } catch (error) {
                        console.error("Error saving next topic:", error);
                    }
                };
            }

            const unsub = onSnapshot(doc(db, PUBLIC_NEXT_TOPIC_DOC), (docSnap) => {
                const topicData = docSnap.exists() ? docSnap.data() : null;
                if (canEdit) {
                    document.getElementById('nextTopicText').value = topicData?.topic || '';
                } else {
                    const displayEl = document.getElementById('nextTopicDisplay');
                    if (topicData) {
                        displayEl.innerHTML = `<p>${topicData.topic}</p><p class="text-xs text-gray-500 mt-4">Posted by ${topicData.authorName}</p>`;
                    } else {
                        displayEl.textContent = 'No topic has been posted for next week yet.';
                    }
                }
            });
            unsubscribeListeners.push(unsub);
        }

        async function renderAttendance() {
            const container = document.getElementById('tab-content-container');
            const canMarkAttendance = ['Early Youth Instructor', 'Early Youth Advisor'].includes(currentUserProfile.role);
            
            let formHTML = '';
            if (canMarkAttendance) {
                 const students = allUsers.filter(u => u.role === 'Early Youth');
                 formHTML = `
                    <div class="mb-6 p-4 glass-effect rounded-lg">
                        <h4 class="text-lg font-bold mb-4">Mark Attendance</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="attendance-marking-grid">
                            ${students.map(student => `
                                <div class="p-3 glass-effect rounded-lg">
                                    <p class="font-semibold">${student.name}</p>
                                    <div class="flex gap-2 mt-2">
                                        <button class="btn-status flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-3 rounded-lg" onclick="markStudentAttendance('${student.id}', 'Present')">Present</button>
                                        <button class="btn-status flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-3 rounded-lg" onclick="markStudentAttendance('${student.id}', 'Absent')">Absent</button>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>`;
            }
            
            container.innerHTML = `${formHTML}<h3 class="text-xl font-bold mb-4">Attendance Records</h3><div id="attendance-list" class="space-y-2"></div>`;
            
            window.markStudentAttendance = async (studentId, status) => {
                 const dateStr = new Date().toISOString().split('T')[0];
                 try {
                    await addDoc(collection(db, PUBLIC_ATTENDANCE_COLLECTION), {
                        studentId, status, date: dateStr,
                        studentName: allUsers.find(u => u.id === studentId)?.name || 'Unknown',
                        markedBy: currentUserProfile.name,
                        createdAt: serverTimestamp()
                    });
                    showCustomAlert(`Attendance marked.`, "Success");
                 } catch(e) {
                    console.error("Error marking attendance: ", e);
                 }
            };

            const q = canMarkAttendance ? collection(db, PUBLIC_ATTENDANCE_COLLECTION) : query(collection(db, PUBLIC_ATTENDANCE_COLLECTION), where('studentId', '==', currentUserId));
            const unsub = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('attendance-list');
                if (!listEl) return;
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-400">No attendance records found.</p>';
                    return;
                }
                const records = snapshot.docs.map(doc => doc.data()).sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                listEl.innerHTML = records.map(rec => `
                    <div class="p-3 glass-effect rounded-lg flex justify-between items-center">
                        <div><span class="font-semibold">${rec.studentName}</span> was <span class="font-bold ${rec.status === 'Present' ? 'text-green-400' : 'text-red-400'}">${rec.status}</span></div>
                        <div class="text-sm text-gray-400"><span>${rec.date}</span><span class="ml-4">by ${rec.markedBy}</span></div>
                    </div>`).join('');
            });
            unsubscribeListeners.push(unsub);
        }
        
        async function renderEvaluations() {
            const container = document.getElementById('tab-content-container');
            const canEvaluate = ['Early Youth Instructor', 'Early Youth Advisor'].includes(currentUserProfile.role);

            let formHTML = '';
            if (canEvaluate) {
                const students = allUsers.filter(u => u.role === 'Early Youth');
                formHTML = `
                    <div class="mb-6 p-4 glass-effect rounded-lg">
                        <h4 class="text-lg font-bold mb-4">Evaluate Students</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="evaluation-grid">
                           ${students.map(student => `<div class="p-3 glass-effect rounded-lg flex justify-between items-center"><p class="font-semibold">${student.name}</p><button class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-1 px-3 rounded-lg" onclick="openEvaluationModal('${student.id}', '${student.name}')">Evaluate</button></div>`).join('')}
                        </div>
                    </div>`;
            }

            container.innerHTML = `${formHTML}<h3 class="text-xl font-bold mb-4">Evaluation Records</h3><div id="evaluations-list" class="space-y-2"></div>`;
            
            window.openEvaluationModal = (studentId, studentName) => {
                const modal = document.getElementById('evaluationModal');
                document.getElementById('evalStudentName').textContent = studentName;
                modal.classList.remove('hidden');
                document.getElementById('saveEvaluationButton').onclick = () => saveEvaluation(studentId);
            };
            
            window.saveEvaluation = async (studentId) => {
                const value = document.getElementById('evaluationValue').value;
                if (!value) { showCustomAlert("Please select an evaluation value."); return; }
                try {
                    await addDoc(collection(db, PUBLIC_EVALUATIONS_COLLECTION), {
                        studentId, evaluation: value,
                        studentName: allUsers.find(u => u.id === studentId)?.name || 'Unknown',
                        evaluatorName: currentUserProfile.name,
                        evaluatorId: currentUserId,
                        createdAt: serverTimestamp()
                    });
                    showCustomAlert("Evaluation submitted.", "Success");
                    document.getElementById('evaluationModal').classList.add('hidden');
                } catch (e) { console.error("Error saving evaluation: ", e); }
            };

            const q = canEvaluate ? collection(db, PUBLIC_EVALUATIONS_COLLECTION) : query(collection(db, PUBLIC_EVALUATIONS_COLLECTION), where('studentId', '==', currentUserId));
            const unsub = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('evaluations-list');
                if (!listEl) return;
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-gray-400">No evaluation records found.</p>'; return; }
                const records = snapshot.docs.map(doc => doc.data()).sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                listEl.innerHTML = records.map(rec => `
                    <div class="p-3 glass-effect rounded-lg flex justify-between items-center">
                        <div><span class="font-semibold">${rec.studentName}</span> received <span class="font-bold text-yellow-400">${rec.evaluation}</span></div>
                        <div class="text-sm text-gray-400"><span>${new Date(rec.createdAt.toMillis()).toLocaleDateString()}</span><span class="ml-4">by ${rec.evaluatorName}</span></div>
                    </div>`).join('');
            });
            unsubscribeListeners.push(unsub);
        }

        async function renderReports() {
            const container = document.getElementById('tab-content-container');
            const canCreate = ['Early Youth Instructor', 'Early Youth Advisor'].includes(currentUserProfile.role);
            
            let formHTML = canCreate ? `
                <div class="mb-6 p-4 glass-effect rounded-lg">
                    <h4 class="text-lg font-bold mb-4">Submit New Report</h4>
                    <textarea id="newReportText" placeholder="Write your report here..." class="form-input w-full p-3 rounded-lg mb-3 h-32"></textarea>
                    <button id="submitReportBtn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Submit</button>
                </div>` : '';

            container.innerHTML = `${formHTML}<h3 class="text-xl font-bold mb-4">Submitted Reports</h3><div id="reports-list" class="space-y-4"></div>`;

            if (canCreate) {
                document.getElementById('submitReportBtn').onclick = async () => {
                    const text = document.getElementById('newReportText').value.trim();
                    if (!text) { showCustomAlert("Report text cannot be empty."); return; }
                    try {
                        await addDoc(collection(db, PUBLIC_REPORTS_COLLECTION), {
                            authorId: currentUserId, authorName: currentUserProfile.name, text,
                            createdAt: serverTimestamp(), lastUpdatedAt: serverTimestamp(), editCount: 0
                        });
                        document.getElementById('newReportText').value = '';
                        showCustomAlert("Report submitted!", "Success");
                    } catch (error) { console.error("Error submitting report:", error); }
                };
            }
            
            const unsub = onSnapshot(collection(db, PUBLIC_REPORTS_COLLECTION), (snapshot) => {
                const list = document.getElementById('reports-list');
                if (!list) return;
                if (snapshot.empty) { list.innerHTML = '<p class="text-gray-400">No reports submitted yet.</p>'; return; }
                const reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                list.innerHTML = reports.map(report => `
                    <div class="p-4 glass-effect rounded-lg cursor-pointer hover:bg-white/10" onclick="viewReport('${report.id}')">
                        <div class="flex justify-between items-start">
                            <p class="font-bold truncate pr-4">Report by ${report.authorName}</p>
                            <p class="text-xs text-gray-400 whitespace-nowrap">${new Date(report.createdAt.toMillis()).toLocaleString()}</p>
                        </div>
                    </div>`).join('');

                window.viewReport = (id) => {
                    const report = reports.find(r => r.id === id);
                    if (!report) return;
                    const modal = document.getElementById('reportModal');
                    const textarea = document.getElementById('reportModalTextarea');
                    const editBtn = document.getElementById('editReportButton');
                    const saveBtn = document.getElementById('saveEditedReportButton');
                    document.getElementById('reportAuthor').textContent = report.authorName;
                    document.getElementById('reportDate').textContent = new Date(report.createdAt.toMillis()).toLocaleString();
                    document.getElementById('editCountInfo').textContent = report.editCount > 0 ? `Edited ${report.editCount} time(s).` : 'Not edited.';
                    textarea.value = report.text;
                    const canEdit = report.authorId === currentUserId;
                    editBtn.classList.toggle('hidden', !canEdit);
                    saveBtn.classList.add('hidden');
                    textarea.readOnly = true;
                    editBtn.onclick = () => { textarea.readOnly = false; textarea.focus(); editBtn.classList.add('hidden'); saveBtn.classList.remove('hidden'); };
                    saveBtn.onclick = async () => {
                        const newText = textarea.value.trim();
                        if (newText === report.text) { modal.classList.add('hidden'); return; }
                        try {
                            await updateDoc(doc(db, PUBLIC_REPORTS_COLLECTION, id), { text: newText, lastUpdatedAt: serverTimestamp(), editCount: (report.editCount || 0) + 1 });
                            modal.classList.add('hidden');
                        } catch (error) { console.error("Error updating report:", error); }
                    };
                    modal.classList.remove('hidden');
                };
            });
            unsubscribeListeners.push(unsub);
        }

        async function renderTodos() {
            const container = document.getElementById('tab-content-container');
            container.innerHTML = `
                <div class="mb-4 flex gap-2">
                    <input type="text" id="newTodoInput" placeholder="Add a new to-do..." class="form-input flex-grow p-3 rounded-lg">
                    <button id="addTodoBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg">Add</button>
                </div>
                <div id="todos-list" class="space-y-2"></div>`;
            document.getElementById('addTodoBtn').onclick = async () => {
                const input = document.getElementById('newTodoInput');
                if (input.value.trim()) {
                    await addDoc(collection(db, getPrivateTodosCollectionPath(currentUserId)), { text: input.value.trim(), completed: false, createdAt: serverTimestamp() });
                    input.value = '';
                }
            };
            const unsub = onSnapshot(collection(db, getPrivateTodosCollectionPath(currentUserId)), (snapshot) => {
                const list = document.getElementById('todos-list');
                if (!list) return;
                const todos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                list.innerHTML = todos.map(todo => `
                    <div class="p-3 glass-effect rounded-lg flex items-center justify-between gap-4">
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo('${todo.id}', this.checked)" class="form-checkbox h-5 w-5 rounded bg-white/20 border-white/30 text-indigo-500 focus:ring-indigo-400">
                        <span class="flex-grow ${todo.completed ? 'line-through text-gray-400' : ''}">${todo.text}</span>
                        <button class="text-yellow-400 hover:text-yellow-300" onclick="openEditTodoModal('${todo.id}', \`${todo.text}\`)"><i class="fas fa-pencil-alt"></i></button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteTodo('${todo.id}')"><i class="fas fa-trash"></i></button>
                    </div>`).join('');
            });
            unsubscribeListeners.push(unsub);
            window.toggleTodo = (id, completed) => updateDoc(doc(db, getPrivateTodosCollectionPath(currentUserId), id), { completed });
            window.deleteTodo = (id) => deleteDoc(doc(db, getPrivateTodosCollectionPath(currentUserId), id));
            window.openEditTodoModal = (id, currentText) => {
                const modal = document.getElementById('editTodoModal');
                const input = document.getElementById('editTodoInput');
                input.value = currentText;
                modal.classList.remove('hidden');
                document.getElementById('saveTodoEditButton').onclick = async () => {
                    if (input.value.trim()) {
                        await updateDoc(doc(db, getPrivateTodosCollectionPath(currentUserId), id), { text: input.value.trim() });
                        modal.classList.add('hidden');
                    }
                };
            };
        }

        async function renderNotes() {
            const container = document.getElementById('tab-content-container');
            container.innerHTML = `
                <div class="mb-4">
                    <textarea id="newNoteInput" placeholder="Write a new note..." class="form-input w-full p-3 rounded-lg h-24"></textarea>
                    <button id="addNoteBtn" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg">Save Note</button>
                </div>
                <div id="notes-list" class="space-y-4"></div>`;
            document.getElementById('addNoteBtn').onclick = async () => {
                const input = document.getElementById('newNoteInput');
                if (input.value.trim()) {
                    await addDoc(collection(db, getPrivateNotesCollectionPath(currentUserId)), { text: input.value.trim(), createdAt: serverTimestamp() });
                    input.value = '';
                }
            };
            const unsub = onSnapshot(collection(db, getPrivateNotesCollectionPath(currentUserId)), (snapshot) => {
                const list = document.getElementById('notes-list');
                if (!list) return;
                const notes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                list.innerHTML = notes.map(note => `
                    <div class="p-4 glass-effect rounded-lg">
                        <p class="whitespace-pre-wrap">${note.text}</p>
                        <div class="text-right mt-2">
                            <span class="text-xs text-gray-400">${new Date(note.createdAt.toMillis()).toLocaleString()}</span>
                            <button class="ml-4 text-red-400 hover:text-red-300" onclick="deleteNote('${note.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('');
            });
            unsubscribeListeners.push(unsub);
            window.deleteNote = (id) => deleteDoc(doc(db, getPrivateNotesCollectionPath(currentUserId), id));
        }

        // --- App Entry Point ---
        document.addEventListener('DOMContentLoaded', initializeAppAndAuth);

    </script>
</body>
</html>
